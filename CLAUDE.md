# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

```bash
# Install dependencies
npm install

# Build TypeScript to dist/
npm run build

# Local development with serverless framework
npm run dev

# Direct Express server (for simple testing)
npm start

# Lint code
npm run lint

# Run scripts with ESM loader (required for TypeScript scripts)
npx ts-node --esm scripts/scriptName.ts
```

## Architecture Overview

Stellium Backend is a serverless astrology service built with Express.js, deployed via AWS Lambda using the Serverless Framework. The application combines Swiss Ephemeris calculations, OpenAI GPT integration, and vector search for astrological chart interpretations.

### Core Data Flow
1. **Ephemeris Calculations**: `sweph` library provides planetary position data from Swiss Ephemeris files in `data/`
2. **Chart Generation**: Birth charts, synastry, composite charts, and transit calculations
3. **AI Interpretation**: OpenAI GPT generates astrological analyses based on chart data
4. **Vector Search**: Pinecone stores and searches generated interpretations for semantic similarity
5. **Persistence**: MongoDB stores users, charts, relationships, and generated content

### Key Services
- **ephemerisDataService.ts**: Swiss Ephemeris wrapper for planetary calculations and transit tracking
- **gptService.ts**: OpenAI integration for generating astrological interpretations
- **dbService.ts**: MongoDB operations for all data persistence
- **vectorize.ts**: Pinecone vector database operations

### Relationship Scoring System
The application includes a sophisticated relationship compatibility scoring system:
- **relationshipScoring.ts**: Core scoring algorithms based on synastry aspects
- **relationship_scoring_stats.json**: Statistical normalization data (generated by `scripts/logScoreAnalysis.ts`)
- **relationshipScoringConstants.ts**: Scoring weights and configuration

### Swiss Ephemeris Integration
- Ephemeris data files (`.se1`) must be present in `data/` directory
- `initializeEphemeris()` must be called before any calculations
- Supports natal charts, progressions, transits, and composite charts
- **Platform Compatibility**: The `sweph` native module requires platform-specific compilation:
  - Production (AWS Lambda): Compiled for Linux ARM64
  - Local Development (macOS): Automatically rebuilds via `postinstall` script
  - The `postinstall` script in `package.json` handles macOS rebuilding automatically

### Transit Tracking
Advanced transit calculation utilities:
- `generateTransitSeries()`: Creates ephemeris time series for date ranges
- `scanTransitSeries()`: Finds exact aspects between transiting and natal planets
- `mergeTransitWindows()`: Groups aspect events into time windows with start/exact/end dates

### Environment Requirements
Required `.env` variables:
- `OPENAI_API_KEY`: OpenAI API access
- `MONGO_CONNECTION_STRING`: MongoDB connection
- `PINECONE_API_KEY`: Vector database access
- `REACT_APP_GOOGLE_API_KEY`: Google services

### ESM Configuration
Project uses ES modules with TypeScript:
- All imports use `.js` extensions (TypeScript compiler requirement)
- Scripts must run with `--esm` flag: `npx ts-node --esm`
- `"type": "module"` in package.json

### Serverless Deployment
- Single Lambda function handles all routes via `serverless-http`
- Routes defined in `routes/indexRoutes.ts`, controllers in `controllers/`
- Development server runs on port 3001 via `serverless offline`

### Utility Scripts
Scripts in `scripts/` directory handle data generation and maintenance:
- Relationship analysis and scoring
- Birth chart bulk processing
- LLM prompt generation
- Statistical analysis for scoring normalization